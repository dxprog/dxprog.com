<!DOCTYPE html>
<html><head><title>Archives - Page 13</title><link rel="stylesheet" type="text/css" href="static/css/index.css"/></head><body><section class="article-list"><article><h2>Riiiiccoollaaa--aa--aa----a------</h2><time>June 4, 2015</time><div><p>Hey, there. It&#39;s been quite some time. About two months, I&#39;d reckon. Actually, I&#39;m not even sure that last post counts for much, being that it was entirely technical. The one before it doesn&#39;t count either, as it was more of an op-ed piece... I guess? I dunno...</p>
<p>So, what exactly has Matt Hackmann been up to since his last meaningful &quot;life update&quot;? Who wants to know? Certainly, you don&#39;t. But, the future me does, so that&#39;s enough to validate my want to write this post. The answer to the original question is fairly simple: not a lot. And also, everything. Maybe it&#39;s not so simple after all.</p>
<p>The easy answer, really, is work. NDA prevents me from mentioning what exactly is going on, but it&#39;s pretty big. Now that I&#39;m a team lead, I&#39;m being challenged in ways that are completely new and foreign to me. Adding to that, I&#39;ve spent the last month or so on a pretty large portion of this project that affects everybody working on this codebase. All of that landed on Monday and since then, I&#39;ve been helping people on-board while also crushing any bugs that crop up. I still have a long way to go until all that is all tied up with a neat little bow, but this is probably the most difficult and certainly the most crucial time in the life cycle. I&#39;m hoping to be able to breathe a little bit once this part is done.</p>
<p>In the now, very little happens outside of work. I spend most of my evenings and weekends just trying to mentally recuperate, which primarily consists of naps and lazing around. However, this is coming off of a fair amount of things that happened in the last few months.</p>
<p>Back in March, I moved from my little apartment in Sunnyvale to a slightly less little apartment in San Mateo. The apartment itself is pretty sweet and the location is even better. There are so many places that are now in walking distance, from ramen shops to the train station to friends houses. Due to the above exhaustion, I haven&#39;t taken as much advantage of this as I should, but once things ease up, I hope to start sampling some more of the food wares in the area. Inside my apartment, I built a couple of sweet desks to fill the larger space in my room, so I now have a space for computer things and a space for electronics things.</p>
<p><img src="http://i.imgur.com/YWUQqEZ.jpg" alt="" title="SO MUCH DESK ROOM FOR ACTIVITIES"></p>
<p>In April, I made another pilgrimage to Japan, this time accompanied by a couple of friends from work. In some regards, I consider this trip to have been more successful than the previous one. I knew better what was going on, and had far, far less fast/conbini food than last time. We also managed to land right in the middle of cherry blossom season which was goddamned gorgeous. Of course, there was plenty of time spent in Akihabara and I came away with many nerdy goods to fill my shelves and to gift to folks. It&#39;s hard to believe that it&#39;s already been almost two months since I&#39;ve been back... or that I even went at all.</p>
<p>So, that&#39;s a bunch of stuff. I&#39;m actually feeling motivated to work on my LED board project right now, so I guess I&#39;ll do that.</p>
<p>Or I&#39;ll binge watch a bunch of Forensic Files &gt;_&gt;</p>
</div></article><article><h2>Fun with Load Balancers and Running on Lean Disk Space</h2><time>March 29, 2015</time><div><p>A while back, I spun up a new server and threw a load balancer on top of it and my existing server. The primary reason at the time was to allow cdn.awwni.me to continue to run while Linode performed some mandatory maintenance on the original server (we&#39;ll call it &quot;Chitoge&quot;). The size of that directory at the time was somewhere around 100GB; my new server (we&#39;ll call that one &quot;Taiga&quot;) has something like 20GB of total space. Obviously, I couldn&#39;t clone from Chitoge to Taiga, so I got a little clever. Using some fun around the hosts file, the nginx site config, and a small <a href="https://github.com/dxprog/rbcdn">PHP script</a>, when a file can&#39;t be found locally, it&#39;d be retrieved from the Amazon S3 store I use as long term backup. S3 is slow, though, so I later changed it to pull directly from Chitoge. This helped both with speed and didn&#39;t count against traffic since internal network traffic is free. In a bout of laziness, instead of opening a connection to that server via IP and hand massaging the &#39;Host&#39; header of the request (or mounting some sort of file share), I just host overrode cdn.awwni.me on Taiga to point to Chitoge. Everything worked great.</p>
<p>Last night, knowing that I was soon to exhaust space on Chitoge (a thing that has happened on more than one occasion), I decided to convert it over to the same setup as Taiga. This would allow me to kill dozens of gigabytes of locally stored images and extend the life of my server plan at least a couple of years. Knowing that I was now deleting Taiga&#39;s source of truth image store, I changed up the script to check from a pool of servers; first try a local server, then if that fails, go to AWS. That worked fine and, while I was setting this script up on Chitoge, I decided that it should check against Taiga just in case it had a copy before wasting time downloading from AWS.</p>
<p>I got everything set up and started deleting old image files. Everything seemed fine, so I let the deleting continue and went to bed.</p>
<p>When I woke up, I was greeted by many messages in my reddit inbox saying that images were experiencing 50x errors. My initial thought was that I was saturating the CPU/connection with that long running process, so I killed it. I was unable to repro any errors, so I went on my merry way... until somebody new complained. Well, fuck...</p>
<p>To make a long story short, because I had pointed each server to each other, I was creating an infinite network loop whenever an non-local image was requesting. Here it is in traffic logs:</p>
<p>[User Request -&gt; Taiga] GET /the_image.jpg
Doesn&#39;t exist locally. Retrieving from first server in pool: <a href="http://cdn.awwni.me/the_image.jpg">http://cdn.awwni.me/the_image.jpg</a> (Forced pointing to Chitoge)
[Taiga -&gt; Chitoge] GET /the_image.jpg
Doesn&#39;t exist locally. Retrieving from first server in pool: <a href="http://cdn.awwni.me/the_image.jpg">http://cdn.awwni.me/the_image.jpg</a> (Forced pointing to Taiga)
[Chitoge -&gt; Taiga] GET /the_image.jpg
Doesn&#39;t exist locally. Retrieving from first server in pool: <a href="http://cdn.awwni.me/the_image.jpg">http://cdn.awwni.me/the_image.jpg</a></p>
<p>So, basically that until the scripts start timing out. Now, in a normal infinite loop, you kill your own process but, generally, should be safe from affecting others. However, here, every time there&#39;s a new request, that&#39;s potentially a new instance of PHP being spun up because the other instances are deadlocked waiting for data. So, eventually, the entire chain collapses and you start getting orangereds in your reddit inbox.</p>
<p>In the end, I still have Taiga sourcing from Chitoge since all image uploads go directly there and, generally, Chitoge will have a copy of the file. Chitoge will always take the AWS hit when a file doesn&#39;t exist to avoid this loop scenario. There are many ways I could avoid this scenario entirely, but for now, this set up is getting the job done.</p>
</div></article></section></body></html>