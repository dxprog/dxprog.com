<!DOCTYPE html>
<html><head><title>It&#x27;s like NES emulator dev all over</title><link rel="stylesheet" type="text/css" href="static/css/index.css"/></head><body><article><h2>It&#x27;s like NES emulator dev all over</h2><time>April 2, 2011</time><div><p><img src="http://images.dxprog.com/blog/jslive.jpg" alt="" title="Yes, my pretties. You will soon be mine!"></p>
<p>Somewhere around the time I began working at Wal-Mart, I thought it would be a nice challenge to write an <a href="http://dxprog.com/entry/one-week-anniversary/">NES emulator</a>. One of these days I&#39;ll release my mess of source code for that, but it was probably one of the most awesome programming challenges I&#39;ve ever undertaken. So, why am I waxing nostalgic about this project from nearly six years ago? (warning - there&#39;s technical programmy talk inside)[break]</p>
<p>Well, you may have garnered from <a href="http://dxprog.com/entry/2010-reviews-finale/">posts past</a> that I may or may not have played visual novels of some anime shows I&#39;ve seen (I have). In particular, those would be Clannad and Kanon. I&#39;ve not fully completed either of these games because, let&#39;s face it, hunching over a computer reading gratuitous amounts of text is tiring. However, I believe the visual novel format would work well on tablet PCs. Interestingly enough, both of these games as well as most things from Key/VisualArts run on a system called <a href="http://haven.parodius.com/formats/#reallive">RealLive</a>. The actual scenario file for each game is a custom scripting language unique to the RealLive engine. My goal is to make an HTML5 based interpreter so I can make these games available to mobile platforms.</p>
<p>This is where the parallel to NES emulators come: I have to reconstruct the functions, logic, etc. that the RealLive system has in JavaScript and HTML. However, whereas emulating a 6502 is just a series of super basic functions (add the accumulator to the X register and jump if the carry flag was set), this is a whole new level of complexity. It&#39;s more akin to writing a C compiler, really. Take this for example:</p>
<p>[code=Kepago]strS[1900] += strS[1900][/code]</p>
<p>Now, in human terms this is pretty simple: add the value of strS[1900] to itself. However, getting a computer to understand this behaviour is something quite different. After a little googling, this is apparently an operation called lexical analysis. My solution is actually a two step process:</p>
<ol>
<li>A PHP script parses the decompiled source code and converts the above into a JSON format like so:</li>
</ol>
<p>[code=JSON]{&quot;action&quot;:&quot;assign&quot;,&quot;name&quot;:&quot;strS[1900]&quot;,&quot;value&quot;:&quot;strS[1901]&quot;,&quot;operation&quot;:&quot;+=&quot;,&quot;ln&quot;:18487}[/code]</p>
<p>Name is what&#39;s on the left hand side of the equation, operation is the operator and value is the right hand side of the operation.</p>
<ol>
<li>Now. that format was setup before I realized that true language parsing was going to be required, so at this point my JavaScript is reconstructing the original equation from those variables. It passes these off to a function called &quot;evaluateExpression&quot; which figures out what&#39;s a string, variable, function, number, operator, etc. and remaps everything so that it points to internal functions and variables. This string would then look like this:</li>
</ol>
<p>[code=JavaScript]variables[&quot;strS[1900]&quot;] += variables[&quot;strS[1900]&quot;][/code]</p>
<p>This string is then run through <em>eval</em> and is parsed by JS natively (allowing me to cop out of writing the really difficult stuff).</p>
<p>So, at this point, I have most all of the branching and logic functions working correctly (as far as I&#39;m aware) in addition to the sound and music (super simple stuff). Now I&#39;m working towards getting the core graphics functions in place which should get me pretty close to a playable state.</p>
<p>It&#39;s been a long time since I&#39;ve had a programming project that&#39;s been this enjoyable and branched me off into new territory. I, for one, welcome it.</p>
</div></article></body></html>