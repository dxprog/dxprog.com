<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>It&#x27;s like NES emulator dev all over - Matt Hackmann</title><link rel="stylesheet" type="text/css" href="https://dxprog.com/static/css/index.css"/></head><body><section class="post-page"><section class="intro-bar intro-bar--small"><img src="https://dxprog.com/static/images/me.jpg" alt="Matt Hackmann" class="intro-bar__photo"/><h1 class="intro-bar__header"><a href="https://dxprog.com/" title="Back to home" class="intro-bar__home-link"><span class="intro-bar__name intro-bar__name--first">Matt</span><span class="intro-bar__name intro-bar__name--last">Hackmann</span></a></h1><h2 class="intro-bar__subhead">The thoughts and goings-on of some programmer dude.</h2><nav class="intro-bar__social-nav"><ul class="social-links"><li class="social-links__item"><a class="social-links__link social-links__link--rss" target="_blank" href="http://feeds.feedburner.com/dxprog">RSS Feed</a></li><li class="social-links__item"><a class="social-links__link social-links__link--github" target="_blank" href="https://github.com/dxprog">GitHub</a></li><li class="social-links__item"><a class="social-links__link social-links__link--twitter" target="_blank" href="https://twitter.com/dxprog">Twitter</a></li><li class="social-links__item"><a class="social-links__link social-links__link--linkedin" target="_blank" href="https://www.linkedin.com/in/mhackmann">LinkedIn Profile</a></li></ul></nav></section><article class="post"><header class="post__header"><h1 class="post__title"><a href="https://dxprog.com/entry/its-like-nes-emulator-dev-all-over">It&#x27;s like NES emulator dev all over</a></h1><time class="post__published">April 2, 2011</time></header><div class="post__content"><p><img src="http://images.dxprog.com/blog/jslive.jpg" alt="" title="Yes, my pretties. You will soon be mine!"></p>
<p>Somewhere around the time I began working at Wal-Mart, I thought it would be a nice challenge to write an <a href="http://dxprog.com/entry/one-week-anniversary/">NES emulator</a>. One of these days I&#39;ll release my mess of source code for that, but it was probably one of the most awesome programming challenges I&#39;ve ever undertaken. So, why am I waxing nostalgic about this project from nearly six years ago? (warning - there&#39;s technical programmy talk inside)</p>
<p>Well, you may have garnered from <a href="http://dxprog.com/entry/2010-reviews-finale/">posts past</a> that I may or may not have played visual novels of some anime shows I&#39;ve seen (I have). In particular, those would be Clannad and Kanon. I&#39;ve not fully completed either of these games because, let&#39;s face it, hunching over a computer reading gratuitous amounts of text is tiring. However, I believe the visual novel format would work well on tablet PCs. Interestingly enough, both of these games as well as most things from Key/VisualArts run on a system called <a href="http://haven.parodius.com/formats/#reallive">RealLive</a>. The actual scenario file for each game is a custom scripting language unique to the RealLive engine. My goal is to make an HTML5 based interpreter so I can make these games available to mobile platforms.</p>
<p>This is where the parallel to NES emulators come: I have to reconstruct the functions, logic, etc. that the RealLive system has in JavaScript and HTML. However, whereas emulating a 6502 is just a series of super basic functions (add the accumulator to the X register and jump if the carry flag was set), this is a whole new level of complexity. It&#39;s more akin to writing a C compiler, really. Take this for example:</p>
<pre><code class="lang-Kepago">strS[1900] += strS[1900]
</code></pre>
<p>Now, in human terms this is pretty simple: add the value of strS[1900] to itself. However, getting a computer to understand this behaviour is something quite different. After a little googling, this is apparently an operation called lexical analysis. My solution is actually a two step process:</p>
<ol>
<li>A PHP script parses the decompiled source code and converts the above into a JSON format like so:</li>
</ol>
<pre><code class="lang-JSON">{<span class="hljs-attr">"action"</span>:<span class="hljs-string">"assign"</span>,<span class="hljs-attr">"name"</span>:<span class="hljs-string">"strS[1900]"</span>,<span class="hljs-attr">"value"</span>:<span class="hljs-string">"strS[1901]"</span>,<span class="hljs-attr">"operation"</span>:<span class="hljs-string">"+="</span>,<span class="hljs-attr">"ln"</span>:<span class="hljs-number">18487</span>}
</code></pre>
<p>Name is what&#39;s on the left hand side of the equation, operation is the operator and value is the right hand side of the operation.</p>
<ol start="2">
<li>Now. that format was setup before I realized that true language parsing was going to be required, so at this point my JavaScript is reconstructing the original equation from those variables. It passes these off to a function called &quot;evaluateExpression&quot; which figures out what&#39;s a string, variable, function, number, operator, etc. and remaps everything so that it points to internal functions and variables. This string would then look like this:</li>
</ol>
<pre><code class="lang-JavaScript">variables[<span class="hljs-string">"strS[1900]"</span>] += variables[<span class="hljs-string">"strS[1900]"</span>]
</code></pre>
<p>This string is then run through <em>eval</em> and is parsed by JS natively (allowing me to cop out of writing the really difficult stuff).</p>
<p>So, at this point, I have most all of the branching and logic functions working correctly (as far as I&#39;m aware) in addition to the sound and music (super simple stuff). Now I&#39;m working towards getting the core graphics functions in place which should get me pretty close to a playable state.</p>
<p>It&#39;s been a long time since I&#39;ve had a programming project that&#39;s been this enjoyable and branched me off into new territory. I, for one, welcome it.</p>
</div></article><aside class="post__foot"><a class="foot-nav foot-nav--prev" title="JsLive - Progress Report and Screenshots" href="https://dxprog.com/entry/jslive-progress-report-and-screenshots">JsLive - Progress Report and Screenshots</a><a class="foot-nav foot-nav--next" title="Whatever happened to children&#x27;s educational programming?" href="https://dxprog.com/entry/whatever-happened-to-childrens-educational-programming">Whatever happened to children&#x27;s educational programming?</a></aside><footer class="footer"><p class="footer__copyright">Copyright Â© 2020 Matt Hackmann</p><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-280226-1"></script><script src="//dxprog.com/static/js/dxprog.js"></script></footer></section></body></html>