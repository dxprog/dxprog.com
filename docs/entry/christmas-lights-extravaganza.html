<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Christmas Lights Extravaganza</title><link rel="stylesheet" type="text/css" href="http://staticr.dxprog.com/static/css/index.css"/></head><body><article class="post"><header class="post__header"><h1 class="post__title"><a href="http://staticr.dxprog.com/entry/christmas-lights-extravaganza">Christmas Lights Extravaganza</a></h1><time class="post__published">December 23, 2012</time></header><div class="post__content"><p>I&#39;ve been sitting on this one for a while now. I&#39;m sure everybody&#39;s seen the video, but I&#39;ve been meaning to do a technical writeup. In case you haven&#39;t seen the video and have no idea what I&#39;m talking about: I made a computer controlled lights setup. You can watch it below:</p>
<p>[![youtube video](<a href="https://img.youtube.com/vi/ufCdZ3xzuUY]">https://img.youtube.com/vi/ufCdZ3xzuUY]</a></p>
<p>Okay, now that we have that out of the way, follow the break for the technical goodies.[break/0.jpg)](<a href="https://www.youtube.com/watch?v=ufCdZ3xzuUY]">https://www.youtube.com/watch?v=ufCdZ3xzuUY]</a></p>
<p>Okay, now that we have that out of the way, follow the break for the technical goodies.[break)</p>
<h2 id="layout">Layout</h2>
<p>Certainly I mentioned it <a href="http://dxprog.com/entry/arduino-project-1-taiko-march/">some time ago</a>, but at the heart of this project is an Arduino Uno. Actually, there are two hearts in this case. The other one is a Raspberry Pi, the $35 micro computer. Both of these pieces perform very different roles, but before I delve into that, have a shoddily drawn &quot;schematic&quot; on how all the parts are connected:</p>
<p><img src="http://images.dxprog.com/blog/tree_lights_schematic.jpg" alt="" title="Grossly simplified"></p>
<p>Here&#39;s a quick rundown of each component and its use:</p>
<p><strong>Relay/Outlet Box</strong> - This is a gang box that consists of four outlets all hooked up into a relay board (<a href="http://www.amazon.com/SainSmart-4-Channel-Relay-Module-Arduino/dp/B0057OC5O8/ref=sr_1_2?ie=UTF8&amp;amp;amp;amp;qid=1356312659&amp;amp;amp;amp;sr=8-2&amp;amp;amp;amp;keywords=relay+board">I used this one</a>). This allows me four separate channels of light control for up to eight strings of lights. The channels in my setup are broken out into the lights on the tree, the star, and two strings of lights on either side of the tree.</p>
<p><strong>Arduino</strong> - The Arduino in this case doesn&#39;t actually do much. It receives commands from the Raspberry Pi via serial communication and toggles the appropriate relay. It also takes input from the button on the proto shield and sends that back to the Pi.</p>
<p><strong>Raspberry Pi</strong> - The Pi is what does most all of the heavy lifting. It plays the music and parses the sequence file to send the correct commands to the Arduino at the appropriate time. It&#39;ll also change display modes upon pressing a button on the Arduino. Pressing the button cycles through the following modes: play loaded light sequence, all on, all off.</p>
<p><img src="http://images.dxprog.com/blog/tree_lights_hardware.jpg" alt="" title="The setup"></p>
<p>That&#39;s the hardware side, let&#39;s move onto the softer side of things.</p>
<h2 id="sequencing">Sequencing</h2>
<p><img src="http://images.dxprog.com/blog/tree_lights_after_effects.jpg" alt="" title="It&#39;s like motion graphics for real life"></p>
<p>All of my sequencing was done in After Effects. I setup a basic scene with all my light channels (mapped to approximations of what they&#39;d be in real life) and the song I was sequencing. I used the opacity property to set the on/off state of each string; 0 was off, non-0 on. Sadly, I forgot all about hold frames until I was nearly done, so I have a lot of side-by-side key frames keeping the previous state. The composition was set at a flat 30fps to make time coding easy later. Once I was done sequencing, I copied each layers key frames into a flat text file for compilation later.</p>
<h2 id="code">Code</h2>
<p>With the hardware and sequencing in place, only code remained. There are three programs used through out the process: one to compile together all the pasted sequences from After Effects into a nice JSON format, the program to parse said file and output data to the Arduino, and the program running on the Arduino itself. Note - there&#39;s not a <em>lot</em> of code, but too much to paste here. I&#39;ve made the entire project available on <a href="https://github.com/dxprog/ChristmasLights">GitHub</a>.</p>
<p><strong>Parsing After Effects Key Frame Data</strong></p>
<p><a href="https://github.com/dxprog/ChristmasLights/blob/master/compile.php">This script was written in PHP</a> because it&#39;s what I work with fastest. The keyframes code was slightly augmented to identify what string was what (String ID). It is then time coded and converted into a nice JSON format. The sequence can be found <a href="https://github.com/dxprog/ChristmasLights/blob/master/holy_night.txt">here</a> and the converter program converts it to some nice <a href="https://raw.github.com/dxprog/ChristmasLights/master/holy_night.js">JSON</a>.</p>
<p><strong>The Raspberry Pi&#39;s Side</strong></p>
<p>This part was initially written in node.js, but I couldn&#39;t find a good library for playing music and keeping tabs on it&#39;s current position. So, I settled for Python and the PyGame library since both are installed by default in the Pi linux distro. The main loop of the script just sits around waiting for button input. The sequence loop parses the JSON file from above, waiting until the music hits a point that requires action. It then sends out the following byte for each command:</p>
<p>AAAABBBB</p>
<p>The upper four bits are the on/off state and the lower four are the string that the action is to be carried out for. It&#39;s pretty simple and keeps the throughput low.</p>
<p><strong>The Arduino Side</strong></p>
<p>As stated above, the Arduino side is very simple: it sits and waits for commands from the Pi or for the button to be pressed. When it receives one of the command bytes, it breaks it down into the two parts and sends HIGH or LOW for the correct pin taking into consideration the fact that I started on digital pin 4. The Arduino code can be found <a href="https://github.com/dxprog/ChristmasLights/blob/master/controller.ino">here</a>.</p>
<p>So, that&#39;s pretty much everything in a nutshell. Overall, for a first attempt doing really anything like this, I&#39;m quite pleased with the results. Next year, I&#39;d like to get away from the relay board (it&#39;s loud as hell) and use MOSFET which would grant me the ability to do fades and not just on/off. Also, I&#39;d like to expand beyond just four channels and perhaps throw in a RGB LED strip for extra fun.</p>
</div></article></body></html>