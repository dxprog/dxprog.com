<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Getting Around the Iron Curtains - Matt Hackmann</title><link rel="stylesheet" type="text/css" href="https://dxprog.com/static/css/index.css"/></head><body><section class="post-page"><section class="intro-bar intro-bar--small"><img src="https://dxprog.com/static/images/me.jpg" alt="Matt Hackmann" class="intro-bar__photo"/><h1 class="intro-bar__header"><a href="https://dxprog.com/" title="Back to home" class="intro-bar__home-link"><span class="intro-bar__name intro-bar__name--first">Matt</span><span class="intro-bar__name intro-bar__name--last">Hackmann</span></a></h1><h2 class="intro-bar__subhead">The thoughts and goings-on of some programmer dude.</h2><nav class="intro-bar__social-nav"><ul class="social-links"><li class="social-links__item"><a class="social-links__link social-links__link--rss" target="_blank" href="http://feeds.feedburner.com/dxprog">RSS Feed</a></li><li class="social-links__item"><a class="social-links__link social-links__link--github" target="_blank" href="https://github.com/dxprog">GitHub</a></li><li class="social-links__item"><a class="social-links__link social-links__link--twitter" target="_blank" href="https://twitter.com/dxprog">Twitter</a></li><li class="social-links__item"><a class="social-links__link social-links__link--linkedin" target="_blank" href="https://www.linkedin.com/in/mhackmann">LinkedIn Profile</a></li></ul></nav></section><article class="post"><header class="post__header"><h1 class="post__title"><a href="https://dxprog.com/entry/getting-around-the-iron-curtains">Getting Around the Iron Curtains</a></h1><time class="post__published">February 23, 2014</time></header><div class="post__content"><p>Last week, a friend clued me into CloudFlare, a CDN service that also somehow has a free tier with unlimited bandwidth. This played right into my fears of hitting the 4TB bandwidth ceiling on my current hosting tier. Put into perspective, that&#39;s pretty close to all the digital storage I have available in my apartment. Also, it quells the fears that users on the other side of the pond are getting subpar download times. So, with minimal weighing of the consequences, I flipped everything over. And, lo and behold, it worked!</p>
<p>Almost...</p>
<p>You see, some countries and ISPs think that blocking shit on the internet is a really great idea. I&#39;m not going to go on a political rampage right now because that&#39;s not my style, but when you&#39;re getting messages about users unable to download content from your hosting due to these reasons, it&#39;s more than a little irritating. But, goddammit, I&#39;m a programmer and there had to be a solution that&#39;d get me the best of both worlds without shelling out additional money.</p>
<p>After disabling the caching layer on that subdomain (cdn.awwni.me), I began weighing my options. Somehow I needed to find out if a particular user had the ability to talk to CloudFlare (now working through licdn.awwni.me). Most views were going to be served straight out of reddit.com, but I had a couple of attack vectors: the redditbooru.com main site, which is hit often for people doing repost checks or looking at albums that have been posted to reddit, and the RedditBooru browser extensions. The former was going to be the easiest to tinker with (so I thought) and affect the most people.</p>
<p>Since I had a way to test availability, I needed to actually perform the test itself. What I devised was an iframe that would be loaded on every page of RedditBooru. It would load the following script:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://licdn.awwni.me/cdncheck.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<pre><code class="lang-javascript"><span class="hljs-comment">// If this page has managed to load, go ahead and set the CDN cookie to expire on my 100th birthday</span>
<span class="hljs-keyword">var</span> date = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2086/6/8'</span>)).toGMTString();
<span class="hljs-built_in">document</span>.cookie = <span class="hljs-string">'use_cdn=true; expires='</span> + date;
</code></pre>
<p>If the user has access to the licdm subdomain, a cookie is set noting such and does so on the cdn.awwni.me domain. Since these users were now marked, this information can be used in nginx to reroute the user.</p>
<pre><code class="lang-nginx"><span class="hljs-attribute">if</span> (<span class="hljs-variable">$host</span> != licdn.awwni.me) {
    <span class="hljs-attribute">set</span> <span class="hljs-variable">$useCdn</span> <span class="hljs-string">"P"</span>;
}

    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$http_cookie</span> <span class="hljs-regexp">~* 'use_cdn')</span> {
    <span class="hljs-attribute">set</span> <span class="hljs-variable">$useCdn</span> <span class="hljs-string">"<span class="hljs-variable">${useCdn}</span>C"</span>;
}

<span class="hljs-attribute">if</span> (<span class="hljs-variable">$useCdn</span> = PC) {
            <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(.*)</span> http://licdn.awwni.me/<span class="hljs-variable">$1</span> <span class="hljs-literal">permanent</span>;
}
</code></pre>
<p>Getting around nginx&#39; inability to do multiple conditionals in one line aside, the above checks to make sure that the cookie is set and that the user is <em>not</em> coming from the licdn.awwni.me domain. That last bit was added when I accidentally set the CDN cookie on licdn and got caught in an infinite redirect loop for a while. If either of the conditions aren&#39;t met, the image will just serve out of my machine.</p>
<p>There are a few drawbacks to this approach. First of all, every request still hits my machine, so I&#39;m still taking a bandwidth hit. Secondly, those getting served out of the CDN have an extra hop for the redirect. However, I believe neither of these issues are bad enough to warrant removing it completely. For starters, on my side I&#39;m now only serving a handful of bytes as opposed to millions. Secondly, a redirect on a single image is pretty much inconsequential to the user&#39;s experience.</p>
<p>I&#39;ve only been running with this solution for a few hours, so I don&#39;t yet have a good look on how great the benefits are. Time will tell on that one, but I haven&#39;t yet heard any issues on images not loading, so there&#39;s some comfort.</p>
</div></article><footer class="footer"><p class="footer__copyright">Copyright Â© 2020 Matt Hackmann</p><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-280226-1"></script><script src="//dxprog.com/static/js/dxprog.js"></script></footer></section></body></html>