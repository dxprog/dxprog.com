<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>RedditBooru v2 - Postmortem</title><link rel="stylesheet" type="text/css" href="http://staticr.dxprog.com/static/css/index.css"/></head><body><article class="post"><header class="post__header"><h1 class="post__title"><a href="http://staticr.dxprog.com/entry/redditbooru-v2-postmortem">RedditBooru v2 - Postmortem</a></h1><time class="post__published">August 3, 2014</time></header><div class="post__content"><p>Back in January, I wrote a rather <a href="http://dxprog.com/entry/systems-architecture-in-the-unknown/">frustrated post</a> about rewriting RedditBooru on a new tech stack and how everything sucked. Six months (almost to the day) after that post, I finally launched the second major revision of the site. That launch was not without a whole bunch of drama.</p>
<h2 id="codebase-direction">Codebase Direction</h2>
<p>In the aforementioned post, I was originally developing on a stack consisting of nodejs and mongoDB. Shortly after, I abandoned nearly everything I had written, the only thing carried over being the few templates that were done. There were many lessons learned in that excursion, particularly &quot;if it ain&#39;t broke, don&#39;t rewrite it&quot;. I decided that instead of again rewriting everything from the ground up, I would work off of the existing codebase and retool that. This proved immediately to be the right idea, as I was able to quickly port many of the new things I&#39;d written in node to PHP but without any of the stability issues. The first of these was the cron job.</p>
<p>The nodejs version of the cron (which was more of a daemon than a cron, really) heavily used async operations which allowed it to index all sources very quickly, generally in a matter of seconds. PHP is by its nature not async friendly, so I employed some clever process management handled by node, something that I&#39;d casually thrown out as an option to resolve my node woes. The node manager keeps a pool of 4 indexer processes running, allowing for multiple sources to be indexed simultaneously in individual hardware threads but with all the benefits of synchronous code for each individual process. This proved to be rock solid right from the start, though did result in high CPU usage as I&#39;d noticed in the first few days after launch. It was enough of an issue that I dropped the maximum number of processes down to one. Turns out I was unnecessarily hammering MySQL for data, and by <a href="https://github.com/dxprog/reddit-booru/commit/1e331512f95f7c61b980573f155629c9cd75f66c">being smarter about my DB calls</a>, CPU usage was dropped almost to 0 and I was able to ramp back up to 4 processes while still utilizing less CPU than in the previous single running process.</p>
<p>One major change I did make to the front-end was to use <a href="http://backbonejs.org/">backbone</a> as my JS framework. The primary reason I did this was to familiarize myself with the MV* frameworks that have been all the rage lately and I know the day is coming when I&#39;ll need to know this stuff for work. The other reason was that it provided logical structure to my JS instead of haphazardly throwing everything into a single JS file. The only issues I had with the framework were around it&#39;s handling of routes, a chunk of code I eventually just <a href="https://github.com/dxprog/reddit-booru/blob/master/static/js/dev/controls/Routes.js">wrote myself</a> to suit my particular use cases. All in all, I&#39;m pretty happy with backbone, but I feel that I probably did not use it to its fullest advantage. I probably could&#39;ve gotten away with no framework and using something like <a href="https://github.com/linkedin/Fiber">Fiber</a> to give me a nice, classical style OOP scheme to work off of.</p>
<h2 id="release-day">Release Day</h2>
<p>So, development went pretty smoothly once I kept doing things I knew how to do. And everything was fine... right up until just before the hard date I&#39;d set for release (June 30th, in this case). A couple days before release, I went over my hosting bandwidth cap on the existing server, something that had been threatening to happen for months. I quickly began scrambling to figure how to route traffic to places where I wouldn&#39;t be paying the enormous overage fees I would be getting from my hosting. During all that, I made the decision that I should just spin the new redditbooru up on a new machine, one with much greater bandwidth caps. Many hours of file copying later, I had all of my sites on the new machine with traffic slowly diverting over there... except for redditbooru. Because of how it names hosted files, this would have to be transferred over last. And everything probably would have gone okay... if I hadn&#39;t forgotten one thing. As the traffic was shifting from the old machine to the new machine, there were weird anomalies showing up with pictures people had posted to reddit, namelyt different people were seeing different things for the same file. At this point, it should be mentioned that a user&#39;s DNS could be in one of four states:</p>
<ul>
<li>pointing to CloudFlare (which would be pointing to one of the following)</li>
<li>pointing to AWS</li>
<li>pointing to the old server</li>
<li>pointing to the new server</li>
</ul>
<p>My initial thoughts were that one or two things slipped through before I migrated the database from the old machine to the new machine. I had disabled uploading on the old one, so there shouldn&#39;t be any collisions. Except for the fact that I&#39;d forgotten to also turn off the indexer on the old box. This was causing the two separate machines to constantly overwrite each other&#39;s images on AWS and since their database IDs were very different, those images would be different as well. And, I was powerless to do anything while the DNS was propagating. Of course, the old indexer was shut down which resolved all issues going forward and I overwrote all the bad images on AWS using the new machine as the source of truth, but it was still a waiting game as that DNS finished up so I could turn off the old server.</p>
<p>It was a hellacious couple of days and I&#39;m honestly surprised anybody still trusted my software after that.</p>
<h2 id="one-month-later">One Month Later</h2>
<p>It&#39;s now one month later and things have finally smoothed out. Of course, there are still some issues I&#39;ve been experiencing with the new software and new machine. For instance, all sites on that machine stopped working a week or two ago. Turns out that MariaDB had enabled binary query logging by default and had exhausted all of the available disk space (some 77GB of logs). MongoDB, which I&#39;d relegated to image caching and internal metrics logging, also just fucking died a couple times, bringing all of RB with it. I&#39;ve since disabled mongo and migrated the image caching to a <a href="https://github.com/dxprog/reddit-booru/commit/1c15499f6c21d98de695cb571640a2cba6cd210a">simple disk based system</a>. This leaves me in a bit of a bind as many features I had planned were going to use mongo for a denormalized data store (stats type things, mostly). I&#39;m currently looking into redis as a possible way replacing this.</p>
<p>All that said, RedditBooru is healthy now and people are taking advantage of the new features built in, particularly the inline image viewer. That feature is so popular that time-on-site has jumped a full minute and my bandwidth for last month approached 6TB, a full 2TB over what my previous bandwidth cap. This is again going to fast become a major issue, one that needs resolving pretty quickly.</p>
<p>I think overall what I can take away from this whole experience is that calm works makes for higher quality work. Panic only brings additional pain.</p>
</div></article></body></html>